요구사항을 반영해서 완성된 정의서를 작성해 드릴게요.

---

## 📋 일본 전력회사 가격 크롤링 시스템 요구사항 정의서 (v1.0)

### 1. 프로젝트 개요

| 항목       | 내용                                                                          |
| ---------- | ----------------------------------------------------------------------------- |
| 프로젝트명 | **Japan Power Price Crawler (JPPC)**                                          |
| 목적       | 일본 주요 전력회사들의 전기 요금 정보를 자동 수집하여 내부 분석용 데이터 제공 |
| 기술 스택  | **Backend**: Python 3.12+ / FastAPI / Playwright / PostgreSQL                 |
|            | **Frontend**: Next.js 14+ / TypeScript / TailwindCSS                          |
|            | **Infra**: Docker / Docker Compose                                            |

---

### 2. 크롤링 대상 전력회사

| #   | 회사명     | 회사명(일본어)   | 지역 | URL                              |
| --- | ---------- | ---------------- | ---- | -------------------------------- |
| 1   | 도쿄전력   | 東京電力 (TEPCO) | 관동 | https://www.tepco.co.jp/         |
| 2   | 츄부전력   | 中部電力         | 중부 | https://miraiz.chuden.co.jp/     |
| 3   | 칸사이전력 | 関西電力 (KEPCO) | 관서 | https://kepco.jp/                |
| 4   | 츄고쿠전력 | 中国電力         | 중국 | https://www.energia-support.com/ |

---

### 3. 기능적 요구사항 (Functional Requirements)

#### 3.1 크롤링 기능 (Backend)

| ID     | 기능                 | 설명                                              | 우선순위 |
| ------ | -------------------- | ------------------------------------------------- | -------- |
| FR-001 | 전력회사 관리        | 크롤링 대상 전력회사 CRUD                         | 상       |
| FR-002 | 요금 정보 수집       | 4개 전력회사 요금 플랜 및 단가 정보 크롤링        | 상       |
| FR-003 | 스케줄 크롤링        | **주 1회** 자동 크롤링 실행 (요일/시간 설정 가능) | 상       |
| FR-004 | 수동 크롤링          | 특정 전력회사 또는 전체를 즉시 크롤링 실행        | 상       |
| FR-005 | 크롤링 상태 모니터링 | 진행 상황, 성공/실패 여부 확인                    | 중       |
| FR-006 | 크롤링 이력 관리     | 실행 이력 저장 및 조회                            | 중       |

#### 3.2 데이터 관리 기능 (Backend)

| ID     | 기능             | 설명                                  | 우선순위 |
| ------ | ---------------- | ------------------------------------- | -------- |
| FR-007 | 요금 데이터 저장 | 수집된 요금 정보를 정규화하여 DB 저장 | 상       |
| FR-008 | 이력 관리        | 요금 변동 이력 추적 (시계열 데이터)   | 상       |
| FR-009 | 데이터 검증      | 수집 데이터의 유효성 검증             | 중       |
| FR-010 | 변경 감지        | 이전 데이터와 비교하여 변경 사항 감지 | 중       |
| FR-011 | 데이터 내보내기  | CSV/Excel 형식으로 데이터 export      | 하       |

#### 3.3 알림 기능 (Backend)

| ID     | 기능             | 설명                              | 우선순위 |
| ------ | ---------------- | --------------------------------- | -------- |
| FR-012 | 이메일 알림 설정 | 알림 수신자 이메일 등록/관리      | 상       |
| FR-013 | 크롤링 실패 알림 | 크롤링 실패 시 이메일 발송        | 상       |
| FR-014 | 요금 변경 알림   | 요금 변동 감지 시 이메일 발송     | 중       |
| FR-015 | 주간 리포트      | 주간 크롤링 결과 요약 이메일 발송 | 하       |

#### 3.4 API 기능 (Backend)

| ID     | 기능              | 설명                                   | 우선순위 |
| ------ | ----------------- | -------------------------------------- | -------- |
| FR-016 | 전력회사 API      | 전력회사 목록 CRUD                     | 상       |
| FR-017 | 요금 조회 API     | 전력회사별/플랜별 요금 정보 조회       | 상       |
| FR-018 | 요금 비교 API     | 복수 전력회사 간 요금 비교 데이터 제공 | 중       |
| FR-019 | 이력 조회 API     | 특정 기간의 요금 변동 이력 조회        | 중       |
| FR-020 | 크롤링 작업 API   | 크롤링 실행/중지/상태 확인             | 상       |
| FR-021 | 대시보드 통계 API | 대시보드용 집계 데이터 제공            | 중       |

#### 3.5 관리 화면 기능 (Frontend - Next.js)

| ID     | 기능               | 설명                                       | 우선순위 |
| ------ | ------------------ | ------------------------------------------ | -------- |
| FR-022 | 대시보드           | 전체 현황 요약 (최근 크롤링, 요금 변동 등) | 상       |
| FR-023 | 전력회사 관리 화면 | 전력회사 목록 조회/등록/수정/삭제          | 상       |
| FR-024 | 요금 정보 화면     | 전력회사별 요금 플랜 조회 및 상세 보기     | 상       |
| FR-025 | 요금 비교 화면     | 전력회사 간 요금 비교 테이블/차트          | 중       |
| FR-026 | 요금 이력 화면     | 기간별 요금 변동 추이 차트                 | 중       |
| FR-027 | 크롤링 관리 화면   | 수동 실행, 스케줄 설정, 실행 이력 조회     | 상       |
| FR-028 | 알림 설정 화면     | 이메일 알림 설정 관리                      | 중       |
| FR-029 | 시스템 설정 화면   | 크롤링 주기, 기본 설정 관리                | 하       |

---

### 4. 비기능적 요구사항 (Non-Functional Requirements)

#### 4.1 성능

| ID      | 요구사항                      | 목표치                     |
| ------- | ----------------------------- | -------------------------- |
| NFR-001 | 단일 사이트 크롤링 시간       | 60초 이내                  |
| NFR-002 | 전체 크롤링 시간 (4개 사이트) | 5분 이내                   |
| NFR-003 | API 응답 시간                 | 300ms 이내 (95 percentile) |
| NFR-004 | 프론트엔드 초기 로딩          | 3초 이내                   |

#### 4.2 안정성

| ID      | 요구사항    | 설명                                          |
| ------- | ----------- | --------------------------------------------- |
| NFR-005 | 재시도 로직 | 실패 시 최대 3회 재시도 (exponential backoff) |
| NFR-006 | 에러 격리   | 개별 사이트 실패가 전체 작업에 영향 없음      |
| NFR-007 | 데이터 백업 | Docker volume을 통한 데이터 영속성 보장       |

#### 4.3 운영

| ID      | 요구사항   | 설명                            |
| ------- | ---------- | ------------------------------- |
| NFR-008 | 로깅       | 구조화된 로그 (JSON format)     |
| NFR-009 | 헬스체크   | /health 엔드포인트 제공         |
| NFR-010 | 컨테이너화 | Docker Compose로 전체 스택 구동 |

#### 4.4 보안 및 준수사항

| ID      | 요구사항        | 설명                            |
| ------- | --------------- | ------------------------------- |
| NFR-011 | robots.txt 준수 | 크롤링 허용 범위 확인 및 준수   |
| NFR-012 | Rate Limiting   | 요청 간격 2초, 서버 부담 최소화 |
| NFR-013 | User-Agent 명시 | 봇 식별 가능한 User-Agent 사용  |
| NFR-014 | 환경변수 관리   | 민감 정보는 .env 파일로 분리    |

---

### 5. 수집 데이터 항목

```
전력회사 정보
├── 회사 ID (PK)
├── 회사명 (한글)
├── 회사명 (일본어)
├── 지역
├── 웹사이트 URL
├── 크롤링 대상 URL
├── 활성화 여부
└── 등록/수정 일시

요금 플랜 정보
├── 플랜 ID (PK)
├── 전력회사 ID (FK)
├── 플랜명
├── 플랜 코드
├── 계약 유형 (가정용/사업용)
├── 계약 용량 (A/kVA)
├── 기본 요금 (円/月)
├── 전력량 요금
│   ├── 1단계 단가 (0~120kWh, 円/kWh)
│   ├── 2단계 단가 (121~300kWh, 円/kWh)
│   └── 3단계 단가 (301kWh~, 円/kWh)
├── 연료비 조정액 (円/kWh)
├── 재생에너지 부과금 (円/kWh)
├── 적용 시작일
├── 수집 일시
└── 데이터 해시 (변경 감지용)

크롤링 이력
├── 이력 ID (PK)
├── 전력회사 ID (FK)
├── 실행 유형 (스케줄/수동)
├── 상태 (대기/진행중/성공/실패)
├── 시작 시간
├── 종료 시간
├── 수집 건수
├── 에러 메시지
└── 상세 로그
```

---

### 6. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Docker Network                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Frontend Container                         │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                    Next.js 14+                          │  │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   │  │   │
│  │  │  │대시보드 │ │요금관리 │ │요금비교 │ │크롤링 관리  │   │  │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────────┘   │  │   │
│  │  │            TailwindCSS + shadcn/ui                      │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                           :3000                               │   │
│  └──────────────────────────────┬───────────────────────────────┘   │
│                                 │ HTTP                               │
│  ┌──────────────────────────────▼───────────────────────────────┐   │
│  │                    Backend Container                          │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                     FastAPI                             │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │   │
│  │  │  │Price API │ │Crawl API │ │Alert API │ │Stats API │   │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                   Service Layer                         │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │   │
│  │  │  │Price Svc │ │Crawl Svc │ │Email Svc │ │Scheduler │   │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                   Crawler Layer                         │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │   │
│  │  │  │  TEPCO   │ │  Chubu   │ │  KEPCO   │ │ Chugoku  │   │  │   │
│  │  │  │ Crawler  │ │ Crawler  │ │ Crawler  │ │ Crawler  │   │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │   │
│  │  │                    Playwright                           │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                           :8000                               │   │
│  └──────────────────────────────┬───────────────────────────────┘   │
│                                 │                                    │
│  ┌──────────────────────────────▼───────────────────────────────┐   │
│  │                    Database Container                         │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                    PostgreSQL 16                        │  │   │
│  │  │     companies │ plans │ prices │ crawl_logs │ alerts   │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                           :5432                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
              ┌─────────────────────────────────────┐
              │         External Services           │
              │  ┌───────────┐    ┌─────────────┐  │
              │  │ 전력회사   │    │ SMTP Server │  │
              │  │ Websites  │    │  (Email)    │  │
              │  └───────────┘    └─────────────┘  │
              └─────────────────────────────────────┘
```

---

### 7. 프로젝트 구조

```
japan-power-price-crawler/
├── docker-compose.yml
├── .env.example
├── README.md
│
├── backend/
│   ├── Dockerfile
│   ├── pyproject.toml
│   ├── requirements.txt
│   │
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                 # FastAPI 엔트리포인트
│   │   ├── config.py               # 설정 관리
│   │   │
│   │   ├── api/
│   │   │   ├── __init__.py
│   │   │   ├── deps.py             # 의존성 주입
│   │   │   └── v1/
│   │   │       ├── __init__.py
│   │   │       ├── companies.py    # 전력회사 API
│   │   │       ├── prices.py       # 요금 API
│   │   │       ├── crawling.py     # 크롤링 API
│   │   │       └── alerts.py       # 알림 API
│   │   │
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   ├── company.py
│   │   │   ├── price_plan.py
│   │   │   ├── crawl_log.py
│   │   │   └── alert_setting.py
│   │   │
│   │   ├── schemas/
│   │   │   ├── __init__.py
│   │   │   ├── company.py
│   │   │   ├── price.py
│   │   │   ├── crawling.py
│   │   │   └── alert.py
│   │   │
│   │   ├── services/
│   │   │   ├── __init__.py
│   │   │   ├── price_service.py
│   │   │   ├── crawl_service.py
│   │   │   ├── email_service.py
│   │   │   └── scheduler_service.py
│   │   │
│   │   ├── crawlers/
│   │   │   ├── __init__.py
│   │   │   ├── base_crawler.py     # 크롤러 베이스 클래스
│   │   │   ├── tepco_crawler.py    # 도쿄전력
│   │   │   ├── chubu_crawler.py    # 츄부전력
│   │   │   ├── kepco_crawler.py    # 칸사이전력
│   │   │   └── chugoku_crawler.py  # 츄고쿠전력
│   │   │
│   │   ├── db/
│   │   │   ├── __init__.py
│   │   │   ├── database.py
│   │   │   └── repositories/
│   │   │       ├── __init__.py
│   │   │       ├── company_repo.py
│   │   │       ├── price_repo.py
│   │   │       └── crawl_log_repo.py
│   │   │
│   │   └── utils/
│   │       ├── __init__.py
│   │       ├── logger.py
│   │       └── helpers.py
│   │
│   ├── alembic/                    # DB 마이그레이션
│   │   ├── alembic.ini
│   │   └── versions/
│   │
│   └── tests/
│       ├── __init__.py
│       ├── conftest.py
│       ├── test_api/
│       └── test_crawlers/
│
├── frontend/
│   ├── Dockerfile
│   ├── package.json
│   ├── next.config.js
│   ├── tailwind.config.js
│   ├── tsconfig.json
│   │
│   ├── src/
│   │   ├── app/
│   │   │   ├── layout.tsx
│   │   │   ├── page.tsx            # 대시보드
│   │   │   ├── companies/
│   │   │   │   ├── page.tsx        # 전력회사 목록
│   │   │   │   └── [id]/
│   │   │   │       └── page.tsx    # 전력회사 상세
│   │   │   ├── prices/
│   │   │   │   ├── page.tsx        # 요금 목록
│   │   │   │   └── compare/
│   │   │   │       └── page.tsx    # 요금 비교
│   │   │   ├── crawling/
│   │   │   │   └── page.tsx        # 크롤링 관리
│   │   │   └── settings/
│   │   │       └── page.tsx        # 설정
│   │   │
│   │   ├── components/
│   │   │   ├── ui/                 # shadcn/ui 컴포넌트
│   │   │   ├── layout/
│   │   │   │   ├── Header.tsx
│   │   │   │   ├── Sidebar.tsx
│   │   │   │   └── Footer.tsx
│   │   │   ├── dashboard/
│   │   │   ├── companies/
│   │   │   ├── prices/
│   │   │   └── crawling/
│   │   │
│   │   ├── lib/
│   │   │   ├── api.ts              # API 클라이언트
│   │   │   └── utils.ts
│   │   │
│   │   ├── hooks/
│   │   │   ├── useCompanies.ts
│   │   │   ├── usePrices.ts
│   │   │   └── useCrawling.ts
│   │   │
│   │   └── types/
│   │       └── index.ts
│   │
│   └── public/
│
└── docs/
    ├── requirements.md             # 이 문서
    ├── api-spec.md                 # API 명세서
    └── database-schema.md          # DB 스키마 문서
```

---

### 8. 기술 스택 상세

#### Backend

| 카테고리   | 기술        | 버전   | 용도             |
| ---------- | ----------- | ------ | ---------------- |
| Language   | Python      | 3.12+  | 메인 언어        |
| Framework  | FastAPI     | 0.115+ | REST API         |
| Crawler    | Playwright  | 1.49+  | 웹 크롤링        |
| ORM        | SQLAlchemy  | 2.0+   | 데이터베이스 ORM |
| Migration  | Alembic     | 1.14+  | DB 마이그레이션  |
| Scheduler  | APScheduler | 3.10+  | 스케줄 작업      |
| Email      | aiosmtplib  | 3.0+   | 이메일 발송      |
| Validation | Pydantic    | 2.10+  | 데이터 검증      |
| Testing    | pytest      | 8.0+   | 테스트           |

#### Frontend

| 카테고리      | 기술           | 버전   | 용도             |
| ------------- | -------------- | ------ | ---------------- |
| Framework     | Next.js        | 14+    | React 프레임워크 |
| Language      | TypeScript     | 5.0+   | 타입 안전성      |
| Styling       | TailwindCSS    | 3.4+   | 스타일링         |
| UI Components | shadcn/ui      | latest | UI 컴포넌트      |
| Charts        | Recharts       | 2.0+   | 차트 시각화      |
| HTTP Client   | Axios          | 1.7+   | API 통신         |
| State         | TanStack Query | 5.0+   | 서버 상태 관리   |

#### Infrastructure

| 카테고리      | 기술           | 버전 | 용도               |
| ------------- | -------------- | ---- | ------------------ |
| Database      | PostgreSQL     | 16+  | 메인 데이터베이스  |
| Container     | Docker         | 24+  | 컨테이너화         |
| Orchestration | Docker Compose | 2.0+ | 멀티 컨테이너 관리 |

---

### 9. 개발 일정 (예상)

| Phase       | 기간  | 내용                                   |
| ----------- | ----- | -------------------------------------- |
| **Phase 1** | 1주차 | 프로젝트 세팅, DB 설계, 기본 API 구조  |
| **Phase 2** | 2주차 | 크롤러 개발 (4개 전력회사)             |
| **Phase 3** | 3주차 | 스케줄러, 이메일 알림 기능             |
| **Phase 4** | 4주차 | 프론트엔드 개발 (대시보드, 기본 화면)  |
| **Phase 5** | 5주차 | 프론트엔드 개발 (요금 비교, 이력 화면) |
| **Phase 6** | 6주차 | 통합 테스트, Docker 최적화, 문서화     |

---

### 10. 리스크 및 대응 방안

| 리스크                    | 영향도 | 대응 방안                                  |
| ------------------------- | ------ | ------------------------------------------ |
| 전력회사 사이트 구조 변경 | 높음   | 크롤러별 모듈화로 개별 수정 용이하게 설계  |
| 크롤링 차단               | 중간   | Rate limiting 준수, 적절한 User-Agent 설정 |
| 일본어 인코딩 이슈        | 중간   | UTF-8 통일, 레거시 인코딩 변환 처리        |
| 요금 체계 복잡성          | 중간   | 유연한 데이터 모델 설계, JSON 필드 활용    |

---
